{
  "hash": "6d15a6f0562a73b7f46605a8790aecdb",
  "result": {
    "markdown": "---\ntitle: \"Teaching modern modeling with tidymodels\"\nsubtitle: \"rstudio::conf(2022) <br> Designing the data science classroom\"\nauthor: \"Maria Tackett\"\nfooter: \"[ğŸ”— rstd.io/teach-ds-conf22](https://rstd.io/teach-ds-conf22) / Module 3\"\nlogo: \"../images/logo.png\"\nformat: \n  revealjs:\n    theme: ../slides.scss\n    multiplex: true\n    transition: fade\n    slide-number: true\n    incremental: false \n    chalkboard: true\nexecute:\n  freeze: auto\n  echo: true\n---\n\n\n# In progress\n\n::: callout-warning\nThese slides are currently being designed and built.\n:::\n\n## Session outline\n\n-   Add agenda\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load packages for slides\nlibrary(tidyverse)\nlibrary(openintro)\nlibrary(countdown)\n```\n:::\n\n\n# Teaching modern modeling\n\n## GAISE guidelines\n\n-   Teach statistical thinking.\n    -   Teach statistics as an investigative process of problem-solving and decision-making.\n    -   Give students experience with multivariable thinking.\n-   Integrate real data with a context and purpose.\n-   Use technology to explore concepts and analyze data.\n\nSee [Guidelines for Assessment and Instruction in Statistics Education (GAISE) 2016 Report](https://www.amstat.org/docs/default-source/amstat-documents/gaisecollege_full.pdf) for full report.\n\n## Teaching modern regression\n\nFacilitate opportunities for students to...\n\n::: incremental\n-   Regularly engage with **real-world applications and complex data**\n\n-   Develop proficiency **using professional statistical software** and using a reproducible workflow\n\n-   Identify **appropriate methods based on the primary analysis objective** - inference or prediction\n\n-   Develop important non-technical skills, specifically written communication and teamwork\n:::\n\n# Introducing tidymodels\n\n## Tidymodels\n\n::: columns\n::: {.column width=\"40%\"}\n![](images/hello-tidymodels.png){fig-align=\"center\"}\n:::\n\n::: {.column width=\"60%\"}\nThe **tidymodels** framework is a collection of packages for modeling and machine learning using tidyverse principles.\n\n<br>\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"tidymodels\")\n```\n:::\n\n:::\n:::\n\n## Tidymodels\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidymodels)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nâ”€â”€ Attaching packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidymodels 1.0.0 â”€â”€\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nâœ” broom        1.0.0     âœ” rsample      1.0.0\nâœ” dials        1.0.0     âœ” tune         1.0.0\nâœ” infer        1.0.2     âœ” workflows    1.0.0\nâœ” modeldata    1.0.0     âœ” workflowsets 1.0.0\nâœ” parsnip      1.0.0     âœ” yardstick    1.0.0\nâœ” recipes      1.0.1     \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nâ”€â”€ Conflicts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidymodels_conflicts() â”€â”€\nâœ– scales::discard() masks purrr::discard()\nâœ– dplyr::filter()   masks stats::filter()\nâœ– recipes::fixed()  masks stringr::fixed()\nâœ– dplyr::lag()      masks stats::lag()\nâœ– yardstick::spec() masks readr::spec()\nâœ– recipes::step()   masks stats::step()\nâ€¢ Dig deeper into tidy modeling with R at https://www.tmwr.org\n```\n:::\n:::\n\n\n## Data: Loans from Lending Club\n\nThe data is the [`loans_full_schema`](http://openintrostat.github.io/openintro/reference/loans_full_schema.html) data set from the **openintro** package and featured in the OpenIntro textbooks .\nIt contains information about 50,000 loans made through the Lending Club platform.\nThe variables we'll use in this analysis are\n\n-   `interest_rate`: Interest rate of the loan the applicant received.\n-   `debt_to_income`: Debt-to-income ratio.\n-   `term`: The number of months of the loan the applicant received.\n-   `delinq_2y`: Number of delinquencies on lines of credit in the last 2 years.\n\n## Data: Loans from Lending Club\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(openintro)\nglimpse(loans_full_schema)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 10,000\nColumns: 55\n$ emp_title                        <chr> \"global config engineer \", \"warehouseâ€¦\n$ emp_length                       <dbl> 3, 10, 3, 1, 10, NA, 10, 10, 10, 3, 1â€¦\n$ state                            <fct> NJ, HI, WI, PA, CA, KY, MI, AZ, NV, Iâ€¦\n$ homeownership                    <fct> MORTGAGE, RENT, RENT, RENT, RENT, OWNâ€¦\n$ annual_income                    <dbl> 90000, 40000, 40000, 30000, 35000, 34â€¦\n$ verified_income                  <fct> Verified, Not Verified, Source Verifiâ€¦\n$ debt_to_income                   <dbl> 18.01, 5.04, 21.15, 10.16, 57.96, 6.4â€¦\n$ annual_income_joint              <dbl> NA, NA, NA, NA, 57000, NA, 155000, NAâ€¦\n$ verification_income_joint        <fct> , , , , Verified, , Not Verified, , ,â€¦\n$ debt_to_income_joint             <dbl> NA, NA, NA, NA, 37.66, NA, 13.12, NA,â€¦\n$ delinq_2y                        <int> 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0â€¦\n$ months_since_last_delinq         <int> 38, NA, 28, NA, NA, 3, NA, 19, 18, NAâ€¦\n$ earliest_credit_line             <dbl> 2001, 1996, 2006, 2007, 2008, 1990, 2â€¦\n$ inquiries_last_12m               <int> 6, 1, 4, 0, 7, 6, 1, 1, 3, 0, 4, 4, 8â€¦\n$ total_credit_lines               <int> 28, 30, 31, 4, 22, 32, 12, 30, 35, 9,â€¦\n$ open_credit_lines                <int> 10, 14, 10, 4, 16, 12, 10, 15, 21, 6,â€¦\n$ total_credit_limit               <int> 70795, 28800, 24193, 25400, 69839, 42â€¦\n$ total_credit_utilized            <int> 38767, 4321, 16000, 4997, 52722, 3898â€¦\n$ num_collections_last_12m         <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0â€¦\n$ num_historical_failed_to_pay     <int> 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0â€¦\n$ months_since_90d_late            <int> 38, NA, 28, NA, NA, 60, NA, 71, 18, Nâ€¦\n$ current_accounts_delinq          <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0â€¦\n$ total_collection_amount_ever     <int> 1250, 0, 432, 0, 0, 0, 0, 0, 0, 0, 0,â€¦\n$ current_installment_accounts     <int> 2, 0, 1, 1, 1, 0, 2, 2, 6, 1, 2, 1, 2â€¦\n$ accounts_opened_24m              <int> 5, 11, 13, 1, 6, 2, 1, 4, 10, 5, 6, 7â€¦\n$ months_since_last_credit_inquiry <int> 5, 8, 7, 15, 4, 5, 9, 7, 4, 17, 3, 4,â€¦\n$ num_satisfactory_accounts        <int> 10, 14, 10, 4, 16, 12, 10, 15, 21, 6,â€¦\n$ num_accounts_120d_past_due       <int> 0, 0, 0, 0, 0, 0, 0, NA, 0, 0, 0, 0, â€¦\n$ num_accounts_30d_past_due        <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0â€¦\n$ num_active_debit_accounts        <int> 2, 3, 3, 2, 10, 1, 3, 5, 11, 3, 2, 2,â€¦\n$ total_debit_limit                <int> 11100, 16500, 4300, 19400, 32700, 272â€¦\n$ num_total_cc_accounts            <int> 14, 24, 14, 3, 20, 27, 8, 16, 19, 7, â€¦\n$ num_open_cc_accounts             <int> 8, 14, 8, 3, 15, 12, 7, 12, 14, 5, 8,â€¦\n$ num_cc_carrying_balance          <int> 6, 4, 6, 2, 13, 5, 6, 10, 14, 3, 5, 3â€¦\n$ num_mort_accounts                <int> 1, 0, 0, 0, 0, 3, 2, 7, 2, 0, 2, 3, 3â€¦\n$ account_never_delinq_percent     <dbl> 92.9, 100.0, 93.5, 100.0, 100.0, 78.1â€¦\n$ tax_liens                        <int> 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0â€¦\n$ public_record_bankrupt           <int> 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0â€¦\n$ loan_purpose                     <fct> moving, debt_consolidation, other, deâ€¦\n$ application_type                 <fct> individual, individual, individual, iâ€¦\n$ loan_amount                      <int> 28000, 5000, 2000, 21600, 23000, 5000â€¦\n$ term                             <dbl> 60, 36, 36, 36, 36, 36, 60, 60, 36, 3â€¦\n$ interest_rate                    <dbl> 14.07, 12.61, 17.09, 6.72, 14.07, 6.7â€¦\n$ installment                      <dbl> 652.53, 167.54, 71.40, 664.19, 786.87â€¦\n$ grade                            <fct> C, C, D, A, C, A, C, B, C, A, C, B, Câ€¦\n$ sub_grade                        <fct> C3, C1, D1, A3, C3, A3, C2, B5, C2, Aâ€¦\n$ issue_month                      <fct> Mar-2018, Feb-2018, Feb-2018, Jan-201â€¦\n$ loan_status                      <fct> Current, Current, Current, Current, Câ€¦\n$ initial_listing_status           <fct> whole, whole, fractional, whole, wholâ€¦\n$ disbursement_method              <fct> Cash, Cash, Cash, Cash, Cash, Cash, Câ€¦\n$ balance                          <dbl> 27015.86, 4651.37, 1824.63, 18853.26,â€¦\n$ paid_total                       <dbl> 1999.330, 499.120, 281.800, 3312.890,â€¦\n$ paid_principal                   <dbl> 984.14, 348.63, 175.37, 2746.74, 1569â€¦\n$ paid_interest                    <dbl> 1015.19, 150.49, 106.43, 566.15, 754.â€¦\n$ paid_late_fees                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0â€¦\n```\n:::\n:::\n\n\n## Regression syntax\n\nFit a linear regression model to predict the interest rate using the debt to income ratio.\n\n::: panel-tabset\n## Base R\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_lm <- lm(interest_rate ~ debt_to_income, data = loans_full_schema)\nsummary(base_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = interest_rate ~ debt_to_income, data = loans_full_schema)\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-21.7391  -3.7203  -0.7945   2.7351  18.6274 \n\nCoefficients:\n                Estimate Std. Error t value Pr(>|t|)    \n(Intercept)    11.511445   0.080732  142.59   <2e-16 ***\ndebt_to_income  0.047183   0.003302   14.29   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 4.948 on 9974 degrees of freedom\n  (24 observations deleted due to missingness)\nMultiple R-squared:  0.02007,\tAdjusted R-squared:  0.01997 \nF-statistic: 204.2 on 1 and 9974 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n\n\n## Tidymodels\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy_lm <- linear_reg() |> \n  set_engine(\"lm\") |>\n  fit(interest_rate ~ debt_to_income, data = loans_full_schema)\n\ntidy(tidy_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 Ã— 5\n  term           estimate std.error statistic  p.value\n  <chr>             <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)     11.5      0.0807      143.  0       \n2 debt_to_income   0.0472   0.00330      14.3 7.05e-46\n```\n:::\n:::\n\n:::\n\n## Model summaries using broom\n\nCan utilize functions from the [**broom**](broom.tidymodels.org) package to produce tidy summaries of models fit using Base R or the tidymodels framework\n\n-   `tidy()`: summarizes information about model components\n\n-   `glance()`: reports information about the entire model\n\n-   `augment()`: adds information about observations to a data set\n\n## `tidy()`\n\n::: panel-tabset\n## `Base R`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_lm <- lm(interest_rate ~ debt_to_income, data = loans_full_schema)\ntidy(base_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 Ã— 5\n  term           estimate std.error statistic  p.value\n  <chr>             <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)     11.5      0.0807      143.  0       \n2 debt_to_income   0.0472   0.00330      14.3 7.05e-46\n```\n:::\n:::\n\n\n## `Tidymodels`\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy_lm <- linear_reg() |> \n  set_engine(\"lm\") |>\n  fit(interest_rate ~ debt_to_income, data = loans_full_schema)\ntidy(tidy_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 Ã— 5\n  term           estimate std.error statistic  p.value\n  <chr>             <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)     11.5      0.0807      143.  0       \n2 debt_to_income   0.0472   0.00330      14.3 7.05e-46\n```\n:::\n:::\n\n:::\n\n## `glance()`\n\n::: panel-tabset\n## Base R\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglance(base_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 Ã— 12\n  r.squared adj.r.squared sigma statistic  p.value    df  logLik    AIC    BIC\n      <dbl>         <dbl> <dbl>     <dbl>    <dbl> <dbl>   <dbl>  <dbl>  <dbl>\n1    0.0201        0.0200  4.95      204. 7.05e-46     1 -30105. 60217. 60238.\n# â€¦ with 3 more variables: deviance <dbl>, df.residual <int>, nobs <int>\n```\n:::\n:::\n\n\n## Tidymodels\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglance(tidy_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 Ã— 12\n  r.squared adj.r.squared sigma statistic  p.value    df  logLik    AIC    BIC\n      <dbl>         <dbl> <dbl>     <dbl>    <dbl> <dbl>   <dbl>  <dbl>  <dbl>\n1    0.0201        0.0200  4.95      204. 7.05e-46     1 -30105. 60217. 60238.\n# â€¦ with 3 more variables: deviance <dbl>, df.residual <int>, nobs <int>\n```\n:::\n:::\n\n:::\n\n## `augment()`\n\n::: panel-tabset\n## Base R\n\n\n::: {.cell}\n\n```{.r .cell-code  code-line-numbers=\"1\"}\nbase_lm_aug <- augment(base_lm)\nbase_lm_aug\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 9,976 Ã— 9\n   .rownames interest_rate debt_to_income .fitted .resid     .hat .sigma .cooksd\n   <chr>             <dbl>          <dbl>   <dbl>  <dbl>    <dbl>  <dbl>   <dbl>\n 1 1                 14.1           18.0     12.4  1.71  0.000101   4.95 6.02e-6\n 2 2                 12.6            5.04    11.7  0.861 0.000191   4.95 2.89e-6\n 3 3                 17.1           21.2     12.5  4.58  0.000102   4.95 4.36e-5\n 4 4                  6.72          10.2     12.0 -5.27  0.000138   4.95 7.80e-5\n 5 5                 14.1           58.0     14.2 -0.176 0.000765   4.95 4.86e-7\n 6 6                  6.72           6.46    11.8 -5.10  0.000174   4.95 9.22e-5\n 7 7                 13.6           23.7     12.6  0.962 0.000109   4.95 2.06e-6\n 8 8                 12.0           16.2     12.3 -0.285 0.000105   4.95 1.74e-7\n 9 9                 13.6           36.5     13.2  0.357 0.000232   4.95 6.04e-7\n10 10                 6.71          18.9     12.4 -5.69  0.000100   4.95 6.64e-5\n# â€¦ with 9,966 more rows, and 1 more variable: .std.resid <dbl>\n```\n:::\n:::\n\n\n## Tidymodels\n\n\n::: {.cell}\n\n```{.r .cell-code  code-line-numbers=\"1\"}\ntidy_lm_aug <- augment(tidy_lm$fit)\ntidy_lm_aug\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 9,976 Ã— 9\n   .rownames interest_rate debt_to_income .fitted .resid     .hat .sigma .cooksd\n   <chr>             <dbl>          <dbl>   <dbl>  <dbl>    <dbl>  <dbl>   <dbl>\n 1 1                 14.1           18.0     12.4  1.71  0.000101   4.95 6.02e-6\n 2 2                 12.6            5.04    11.7  0.861 0.000191   4.95 2.89e-6\n 3 3                 17.1           21.2     12.5  4.58  0.000102   4.95 4.36e-5\n 4 4                  6.72          10.2     12.0 -5.27  0.000138   4.95 7.80e-5\n 5 5                 14.1           58.0     14.2 -0.176 0.000765   4.95 4.86e-7\n 6 6                  6.72           6.46    11.8 -5.10  0.000174   4.95 9.22e-5\n 7 7                 13.6           23.7     12.6  0.962 0.000109   4.95 2.06e-6\n 8 8                 12.0           16.2     12.3 -0.285 0.000105   4.95 1.74e-7\n 9 9                 13.6           36.5     13.2  0.357 0.000232   4.95 6.04e-7\n10 10                 6.71          18.9     12.4 -5.69  0.000100   4.95 6.64e-5\n# â€¦ with 9,966 more rows, and 1 more variable: .std.resid <dbl>\n```\n:::\n:::\n\n:::\n\n## Why Tidymodels?\n\nThere are advantages for more advanced modeling:\n\n-   Consistent syntax for different model types (linear, logistic, random forest, Bayesian, etc.\n-   Streamline modeling workflow\n    -   Split data into train and test sets\n    -   Transform and create new variables\n    -   Assess model performance\n    -   Use model for prediction and inference\n\n# Teaching with tidymodels\n\n## Tidymodels syntax\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlinear_reg() |> \n  set_engine(\"lm\") |>\n  fit(interest_rate ~ debt_to_income, data = loans_full_schema) |>\n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 Ã— 5\n  term           estimate std.error statistic  p.value\n  <chr>             <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)     11.5      0.0807      143.  0       \n2 debt_to_income   0.0472   0.00330      14.3 7.05e-46\n```\n:::\n:::\n\n\nLet's break down the syntax.\n\n## 1ï¸âƒ£ Specify model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlinear_reg() \n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear Regression Model Specification (regression)\n\nComputational engine: lm \n```\n:::\n:::\n\n\n## 2ï¸âƒ£ Set computational engine\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlinear_reg() |> \n  set_engine(\"lm\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear Regression Model Specification (regression)\n\nComputational engine: lm \n```\n:::\n:::\n\n\n## 3ï¸âƒ£ Fit the model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlinear_reg() |> \n  set_engine(\"lm\") |>\n  fit(interest_rate ~ debt_to_income, data = loans_full_schema)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nparsnip model object\n\n\nCall:\nstats::lm(formula = interest_rate ~ debt_to_income, data = data)\n\nCoefficients:\n   (Intercept)  debt_to_income  \n      11.51145         0.04718  \n```\n:::\n:::\n\n\n## 4ï¸âƒ£ Summarize output\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlinear_reg() |> \n  set_engine(\"lm\") |>\n  fit(interest_rate ~ debt_to_income, data = loans_full_schema) |>\n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 Ã— 5\n  term           estimate std.error statistic  p.value\n  <chr>             <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)     11.5      0.0807      143.  0       \n2 debt_to_income   0.0472   0.00330      14.3 7.05e-46\n```\n:::\n:::\n\n\n## Consistent syntax for other models\n\nThe syntax is the same if we fit a more advanced model, such as a logistic regression model.\n\n. . .\n\n*Fit a model to predict the loan term length (36 or 60 months) based on the loan amount.*\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlogistic_reg() |>\n  set_engine(\"glm\") |>\n  fit(factor(term) ~ loan_amount, data = loans_full_schema) |>\n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 Ã— 5\n  term          estimate  std.error statistic   p.value\n  <chr>            <dbl>      <dbl>     <dbl>     <dbl>\n1 (Intercept) -2.28      0.0493         -46.2 0        \n2 loan_amount  0.0000814 0.00000232      35.1 1.02e-269\n```\n:::\n:::\n\n\n## Feature engineering\n\n::: incremental\n-   **Feature engineering** is the process of transforming raw variables in preparation for use in a statistical model.\n\n-   You may be familiar doing feature engineering using dplyr before fitting the model.\n\n-   The [recipes](https://recipes.tidymodels.org/) package makes it possible to do feature engineering as part of the modeling workflow using \"dplyr-like\" functions.\n:::\n\n## Example: Predicting interest rate\n\n::: incremental\n-   **Goal**: Fit a model to predict the interest rate based on the term, debt to income ratio, and number of delinquencies in the past two years.\n\n-   We need to do the following to prepare the predictors for the model:\n\n    -   Make `term` a factor.\n\n    -   Mean-center `debt_to_income`.\n\n    -   Split `delinq_2y` into the categories 0, 1, 2, 3+.\n:::\n\n## Feature engineering using dplyr\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Feature engineering\nloans_full_schema <- loans_full_schema |>\n  mutate(term_fct = as_factor(term)) |>\n  mutate(debt_to_income_cent = \n           debt_to_income - mean(debt_to_income, na.rm = TRUE)) |>\n  mutate(delinq_2y_cat = \n           cut(delinq_2y, breaks = c(-Inf,0,1, 2, 3, Inf)))\n\n# Fit the model \nlm(interest_rate ~ term_fct + debt_to_income_cent + delinq_2y_cat,\n   data = loans_full_schema) |>\n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 7 Ã— 5\n  term                  estimate std.error statistic   p.value\n  <chr>                    <dbl>     <dbl>     <dbl>     <dbl>\n1 (Intercept)            11.0      0.0584     189.   0        \n2 term_fct60              3.86     0.100       38.5  6.67e-303\n3 debt_to_income_cent     0.0429   0.00307     14.0  5.47e- 44\n4 delinq_2y_cat(0,1]      1.37     0.153        8.95 4.08e- 19\n5 delinq_2y_cat(1,2]      1.68     0.291        5.76 8.57e-  9\n6 delinq_2y_cat(2,3]      2.46     0.492        5.00 5.78e-  7\n7 delinq_2y_cat(3, Inf]   2.85     0.563        5.05 4.39e-  7\n```\n:::\n:::\n\n\n## Feature engineering with recipes\n\n![Illustration by [Allison Horst](https://www.allisonhorst.com/)](images/recipes.png){fig-align=\"center\"}\n\n## Specify the variables\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_rec <- recipe(\n  interest_rate ~ term + debt_to_income + delinq_2y, \n  data = loans_full_schema \n  )\n\ninterest_rec\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRecipe\n\nInputs:\n\n      role #variables\n   outcome          1\n predictor          3\n```\n:::\n:::\n\n\n## Define pre-processing steps\n\n**Make `term` a factor.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_rec <- interest_rec |>\n  step_mutate(term = as_factor(term))\n\ninterest_rec\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRecipe\n\nInputs:\n\n      role #variables\n   outcome          1\n predictor          3\n\nOperations:\n\nVariable mutation for as_factor(term)\n```\n:::\n:::\n\n\n## Define pre-processing steps\n\n**Mean-center `debt_to_income`**.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_rec <- interest_rec |>\n  step_center(debt_to_income)\n\ninterest_rec\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRecipe\n\nInputs:\n\n      role #variables\n   outcome          1\n predictor          3\n\nOperations:\n\nVariable mutation for as_factor(term)\nCentering for debt_to_income\n```\n:::\n:::\n\n\n## Define pre-processing steps\n\n**Break `delinq_2y` into the categories 0, 1, 2, 3+.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_rec <- interest_rec |>\n  step_cut(delinq_2y, breaks = c(-Inf,0,1, 2, 3, Inf))\n\ninterest_rec\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRecipe\n\nInputs:\n\n      role #variables\n   outcome          1\n predictor          3\n\nOperations:\n\nVariable mutation for as_factor(term)\nCentering for debt_to_income\nCut numeric for delinq_2y\n```\n:::\n:::\n\n\n## Putting it all together\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_rec <- recipe(interest_rate ~ term + debt_to_income + delinq_2y,\n                       data = loans_full_schema) |>\n  step_mutate(term = as_factor(term))|>\n  step_center(debt_to_income) |>\n  step_cut(delinq_2y, breaks = c(-Inf,0,1, 2, 3, Inf))\n```\n:::\n\n\n## Putting it all together\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_rec\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRecipe\n\nInputs:\n\n      role #variables\n   outcome          1\n predictor          3\n\nOperations:\n\nVariable mutation for as_factor(term)\nCentering for debt_to_income\nCut numeric for delinq_2y\n```\n:::\n:::\n\n\n## Prep and bake to see created variables\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_rec |>\n  prep()|>\n  bake(loans_full_schema) |>\n  head()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 Ã— 4\n  term  debt_to_income delinq_2y interest_rate\n  <fct>          <dbl> <fct>             <dbl>\n1 60             -1.30 [-Inf,0]          14.1 \n2 36            -14.3  [-Inf,0]          12.6 \n3 36              1.84 [-Inf,0]          17.1 \n4 36             -9.15 [-Inf,0]           6.72\n5 36             38.7  [-Inf,0]          14.1 \n6 36            -12.8  (0,1]              6.72\n```\n:::\n:::\n\n\n## Your turn!\n\n## Fit the model using `workflow()`\n\n**Workflows** bring together models and recipes, making them easier to apply to multiple data sets, e.g, training and test data.\n\n. . .\n\n**Specify the model**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_spec <- linear_reg() |>\n  set_engine(\"lm\")\n```\n:::\n\n\n. . .\n\n**Build workflow**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_workflow <- workflow() |>\n  add_model(interest_spec) |>\n  add_recipe(interest_rec)\n```\n:::\n\n\n## View workflow\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_workflow\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nâ•â• Workflow â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPreprocessor: Recipe\nModel: linear_reg()\n\nâ”€â”€ Preprocessor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n3 Recipe Steps\n\nâ€¢ step_mutate()\nâ€¢ step_center()\nâ€¢ step_cut()\n\nâ”€â”€ Model â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nLinear Regression Model Specification (regression)\n\nComputational engine: lm \n```\n:::\n:::\n\n\n## Fit model to data\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_fit <- interest_workflow %>%\n  fit(data = loans_full_schema)\n\ntidy(interest_fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 7 Ã— 5\n  term              estimate std.error statistic   p.value\n  <chr>                <dbl>     <dbl>     <dbl>     <dbl>\n1 (Intercept)        11.0      0.0584     189.   0        \n2 term60              3.86     0.100       38.5  6.67e-303\n3 debt_to_income      0.0429   0.00307     14.0  5.47e- 44\n4 delinq_2y(0,1]      1.37     0.153        8.95 4.08e- 19\n5 delinq_2y(1,2]      1.68     0.291        5.76 8.57e-  9\n6 delinq_2y(2,3]      2.46     0.492        5.00 5.78e-  7\n7 delinq_2y(3, Inf]   2.85     0.563        5.05 4.39e-  7\n```\n:::\n:::\n\n\n# Prediction + Model evaluation\n\n## Make predictions\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_pred <- predict(interest_fit, loans_full_schema) |> \n  bind_cols(loans_full_schema |> select(interest_rate))\n\ninterest_pred\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 10,000 Ã— 2\n   .pred interest_rate\n   <dbl>         <dbl>\n 1  14.8         14.1 \n 2  10.4         12.6 \n 3  11.1         17.1 \n 4  10.6          6.72\n 5  12.7         14.1 \n 6  11.8          6.72\n 7  15.1         13.6 \n 8  16.1         12.0 \n 9  13.1         13.6 \n10  11.0          6.71\n# â€¦ with 9,990 more rows\n```\n:::\n:::\n\n\n## Model evaluation: $R^2$\n\n$R^2$ is the percent of variability in the interest rate explained by the model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrsq(interest_pred, truth = interest_rate, estimate = .pred)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 Ã— 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 rsq     standard       0.157\n```\n:::\n:::\n\n\n## Model evaluation: $RMSE$\n\n$RMSE$ is a measure of the error in the model predictions.\n\n\n$$\nRMSE = \\sqrt{\\frac{\\sum_{i=1}^{n}(\\hat{y}_i - y_i)^2}{n}}\n$$\n\n\n. . .\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrmse(interest_pred, truth = interest_rate, estimate = .pred)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 Ã— 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 rmse    standard        4.59\n```\n:::\n:::\n\n\n## Your turn! (7 minutes)\n\n# What is a limitation to the model evaluation we've done thus far?\n\n## Splitting the data\n\nSplitting the data into training and testing sets allows us to evaluate the model on new data.\n\n. . .\n\n**Split the data.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(0725) #to get same split each run\nloans_split <- initial_split(loans_full_schema, prop = 0.8) #80% training\n```\n:::\n\n\n**Save the training data.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nloans_train <- training(loans_split)\ndim(loans_train)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 8000   58\n```\n:::\n:::\n\n\n**Save test data.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nloans_test <- testing(loans_split)\ndim(loans_test)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 2000   58\n```\n:::\n:::\n\n\n## Fit the model to the training data\n\nWe can fit the model specified in `interest_workflow` (model spec + recipe) to the training data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_train_fit <- interest_workflow |>\n  fit(data = loans_train)\n\ntidy(interest_train_fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 7 Ã— 5\n  term              estimate std.error statistic   p.value\n  <chr>                <dbl>     <dbl>     <dbl>     <dbl>\n1 (Intercept)        11.0      0.0646     170.   0        \n2 term60              3.91     0.112       35.1  1.05e-250\n3 debt_to_income      0.0402   0.00331     12.2  1.12e- 33\n4 delinq_2y(0,1]      1.33     0.171        7.79 7.77e- 15\n5 delinq_2y(1,2]      1.75     0.323        5.41 6.38e-  8\n6 delinq_2y(2,3]      2.48     0.536        4.63 3.79e-  6\n7 delinq_2y(3, Inf]   3.01     0.617        4.88 1.09e-  6\n```\n:::\n:::\n\n\n## Evaluate performance on training data\n\n**Calculate predictions**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_train_pred <- predict(interest_train_fit, loans_train) |> \n  bind_cols(loans_train |> select(interest_rate))\n```\n:::\n\n\n**Evaluate model**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrsq(interest_train_pred, truth = interest_rate, estimate = .pred)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 Ã— 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 rsq     standard       0.161\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrmse(interest_train_pred, truth = interest_rate, estimate = .pred)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 Ã— 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 rmse    standard        4.55\n```\n:::\n:::\n\n\n## Evaluate performance on testing data\n\n**Calculate predictions**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterest_test_pred <- predict(interest_train_fit, loans_test) |> \n  bind_cols(loans_test |> select(interest_rate))\n```\n:::\n\n\n**Evaluate model**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrsq(interest_test_pred, truth = interest_rate, estimate = .pred)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 Ã— 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 rsq     standard       0.140\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrmse(interest_test_pred, truth = interest_rate, estimate = .pred)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 Ã— 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 rmse    standard        4.73\n```\n:::\n:::\n\n\n## Your turn!\n\n## Discussion\n\n::: question\n-   What is something from this module you can implement in your data science course?\n\n-   What is one potential challenge of implementing this content in your course?\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncountdown(minutes = 7, font_size = \"1.5em\")\n```\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"countdown\" id=\"timer_62de2206\" style=\"right:0;bottom:0;font-size:1.5em;\" data-warnwhen=\"0\">\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">07</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/countdown-0.3.5/countdown.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/countdown-0.3.5/countdown.js\"></script>\n"
      ],
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    function fireSlideChanged(previousSlide, currentSlide) {\n\n      // dispatch for htmlwidgets\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for reveal\n    if (window.Reveal) {\n      window.Reveal.addEventListener(\"slidechanged\", function(event) {\n        fireSlideChanged(event.previousSlide, event.currentSlide);\n      });\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}